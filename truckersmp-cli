#!/bin/sh

if [ -z "$1" ]; then
    echo "Usage: truckersmp-cli GAMEDIR"
    exit
fi

listurl=https://update.ets2mp.com
dlurl=https://download.ets2mp.com/files
base="$(dirname $0)"
dldir="truckersmp"
steampath="~/.wine/drive_c/Program Files (x86)/Steam/Steam.exe"

curdir=$(pwd)
cd "$base"

mkdir -p "./$dldir"
wget -O - "$listurl/files.json" > "./files.json"

cat "./files.json" | awk 'BEGIN{i=0}/":"/{printf $0;i=1;next}{if (i) {printf "\n"; i=0}}' | awk -F '"' '{printf "%s ./truckersmp%s\n",$8,$4}' > "./.checksums"
files="$(cat "./.checksums" | md5sum -c --quiet - 2> /dev/null | awk -F ':' '{print $1}' | sed 's,\./'"$dldir"'/,,g')"

for f in $files; do
    echo "f = $f"
    mkdir -p "./$dldir/$(dirname $f)"
    wget -O - $dlurl/$f > "./$dldir/$f"
    if [ ! $? -eq 0 ]; then
        errors=1
    fi
done

rm -f "./.checksums"

if [ ! -z $errors ] && [ "$errors" = "1" ]; then
    read -p "Some Errors Occured during the Downloading of Files, Continue or Try Again? [C/T]" $userinp1
    if [ "$userinp1" = "C" ] || [ "$userinp1" = "c" ] || [ "$userinp1" = "Continue" ] || [ "$userinp1" = "continue" ]; then
    else
        rm -rf "./truckersmp" "./files.json"
        #Relaunch to try again
        "$0"
        exit 0
    fi
fi

echo ""
echo "###################################################################"
echo "#                                                                 #"
echo "#  Please check that steam is running or the launcher won't work  #"
echo "#                                                                 #"
echo "###################################################################"
echo ""
echo "Press enter if you are good to go:"
read

cd "$curdir"

WINEDEBUG=-all,WINEARCH=win64 wine "$base/truckersmp-cli.exe" "$1" "$base/$dldir"
